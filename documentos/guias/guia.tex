\documentclass[a4paper]{article}

% Preambulo por defecto
\input{preamble.tex}

\input{commands.tex}

\begin{document}

\section*{Introducción}
\label{sec:intro}
 
\section{Un viaje del sol a los pixeles.}
\label{sec:fep}
 En esta primera práctica nos familiarizaremos con las interfaces gráficas del
 qgis y de R-studio. Para esto comenzaremos a analizar la imagen correspondiente
 a la zona de estudio del año 2015 desde el punto de vista espectral. Son
 nuestros objetivos

 \begin{itemize}
     \item Poder cargar una imagen en qgis.
     \item Digitalizar coberturas en qgis.
     \item Poder cargar un archivo raster y uno vectorial en R.
     \item Realizar un análisis estadistico de la imagen como un todo y de las
         distintan coberturas digitalizar en R.
 \end{itemize}
\subsection{Exploración con el qgis}
\label{sub:fep:qgis}

 Comenzamos abriendo la imagen \file{l8} correspondiente a la zona de interés
 durante el mes de mayo de 2015. Para esto vamos al menú \menu{Capa, Añadir
 capa, Añadir capa ráster}. Navegamos hasta la carpeta
 \file{raster\_data/LC82300772015071} y abrimos el archivo
 \file{LC82300772015071.brk}. Una vez abierto el mismo podrémos encontarrlo en
 el \menu{Panel de capas} de q-gis donde podremos manejar la visualización del
 mismo y estudiar las propiedades de dicha capa.

 Usando la barra de herramientas del qgis podremos movernos en la imagen,
 realizar zoom en la misma entontre otros.

 \begin{act} 
     Cambie la combinación de bandas de la imagen L8 y muevase  dentro de la
     misma.
 \end{act}

 \begin{act}
     Encuentre el sistema de coordenadas en el cual se encuentra la imagen.
 \end{act}
 
 \begin{act}
    Utilizando la herramienta identificar objetos espaciles encuentre los
    valores de reflectancia de distintas coberturas. Grafique estos  valores en
    una firma espectral y en el espacio de fases nirrojo.
 \end{act}

 Con la herramienta nueva capa de archivo shape es posible digitalizar zonas de
 la imagen para su posterior analisis. Para esto puede hacer click en el boton
 del panel lateral y agregar una capa nueva para lo cual el qgis pedira un
 nombre de la misma. Guardela en la carpeta \file{vector\_data/} con el nombre
 \file{firmas.shp}. Recuerde elegir el sistema de coordenadas correspondiente a
 la imagen anterior.

 Una vez creada la nueva capa podemos utilizar la barra de herramientas de qgis
 para agregar nuevas geometrias a la misma. Para esto hacemos click en el boton
 de agregar geometrica y digitalizamos una zona uniforme dentro de la imagen. Al
 terminar de acerlo qgis pedira un numero de ID para la capa que debe ser
 correlativo.
 
 \begin{act}
    Digitalize coberturas uniformes dentro de la imagen. Recuerde obtener al
    menos una por cada categoria de uso y cobertura presente dentro de la misma.
 \end{act}

 \begin{act}
    Utilizando la herramienta de tabla de datos de la imagen modifique la tabla
    de datos para incluir la categoria de la cobertura, la subcategoria y una 
    pequeña descripcion.
 \end{act}


\subsection{Exploracion en R}
\label{sub:fep:r}
 Para trabajar en R deberemos primero cargar las librerias necesarias con el
 comando

 \begin{lstlisting}
    library(raster)
 \end{lstlisting}

 además, deberemos situar nuestra carpeta de trabajo donde se encuentran las
 carpetas que descargamos. Para esto nos movemos en el explorar de archivos
 hasta la misma y hacemos click en usar la carpeta como carpeta de trabajo.

 Una vez en dicha carpeta, existen varias maneras de abrir una imagen segun
 queramos hacerlo solo para una banda, varias bandas en archivos separados o un
 solo archivo multibanda.

 Los comandos para esto son \texttt{raster}, para abrir una unica banda,
 \texttt{brick}, para abrir un archivo multibanda, y \texttt{stack} para abrir
 distinas bandas por separado. Veamos algunos ejemplo de esto:

 \begin{exa}
    Abrimos la imagen completa del archivo de landsat 8 y consultamos sus 
    propiedades.
 \begin{lstlisting}
    l8 <- brick(filename)
    l8
 \end{lstlisting}
 \end{exa}


 Una vez abierta la imagen en el R podemos empezar a trabajar con la misma
 utilizando distintos comandos. 

 Veamos primero como cambiar los nombres de las bandas por defecto, cambiar la
 imagen a numeros en reflectancia entre 0 y 1 y luego guardarla nuevamente. Para
 eso ejecutamos el siguiente codigo.

 \begin{lstlisting}
     l8 <- brick(filename)
     names(l8) <- c("blue","gree","red","nir","swir1","swir2")
     l8 <- l8/1e4
     rasterOptions(addheader = "ENVI")
     writeRaster(l8\_ref,"raster\_data/processed/")
 \end{lstlisting}

 Analicemos el codigo linea por linea. La primera de ellas abre la imagen como
 un raster de multiples bandas. La segunda, cambia los nombres de cada banda a
 los que figuran en la lista entre parentesis. Es importante resaltar que el
 numero de nombres debe ser el mismo que el de bandas. En tercer lugar
 convertimos el archivo de numeros enteros entre 0 y 10000 a numeros entre 0 y
 1. En la cuarta linea incluimos el archivo header que nos permitira levantar
 nuestra imagen con qgis. Por ulitmo, guardamos el archivo en el formato nativo
 de R.
 
 \begin{act} 
    Abra el archivo vrt en qgis y vuelva a mirar la firma espectral para 
    distintas coberturas. Entre que valores se encuentra ahora las mismas.
 \end{act}

 Hagamos un poco de analisis ahora sobre la imagen. Para comenzar podemos
 calcular los histogramas de todas las bandas con el comando

 \begin{lstlisting}
    hist(l8) 
 \end{lstlisting}

 y el scatter plot entre dos bandas como

 \begin{lstlisting}
    plot(l8$red, l8$blue)    
 \end{lstlisting}

 en caso de querer todos los scatterplots e histogramas en un solo grafico
 podemos hacerlo con el comando

 \begin{lstlisting}
     pairs(l8)
 \end{lstlisting}

 Hasta ahora estamos analizando la imagen completa. Podemos sin embargo analizar
 solo sectores concretos de la imagen muestreandola en funcion de un shapefile.
 Para esto debemos primero abrir el shapefile de interes cargando primero la
 libreria

 \begin{lstlisting}
     library(rgal)
 \end{lstlisting}

 y luego leyendo el vector como

 \begin{lstlisting}
     vector <- readOGR(dsn="vector\_data/", layer="extract")
 \end{lstlisting}

 Podemos mostrar las propiedades del vector ejecutando el comando

 \begin{lstlisting}
     vector
 \end{lstlisting}

 \begin{act} 
    Muestre las propiedades de la capa raster y el vector abiertos y verifique
    que los mismos se encuentren en el mismo sistema de coordenadas.
 \end{act}

 Podemos mostrar las imagenes dentro de R si así nos interesa. Para esto
 utilizaremos la libreria \texttt{ggplot} como se muestra a continuacion

 \begin{lstlisting}
    ggRGB(l8, r="nir",g="red",b="blue", geom_raster=TRUE) 
 \end{lstlisting}

 Por ultimo mostremos como extraer datos de un archivo raster y veamos un par de
 ejemplo concretos. La funcion que nos permite extrar datos de un raster segun
 un vector es \texttt{extract} que toma dos argumentos
 \begin{lstlisting}
     raster(l8,vector)
 \end{lstlisting}

 Veamos algunos ejemplos que pueden ser utiles de aplicacion de todo lo anterior

 \begin{exa}
    Graficar en un scatterplot de dos bandas mostrando la zona del espacio 
    ocupada por una cobertura.
 \begin{lstlisting}
    plot(l8$red, l8$nir)
    points(as.data.frame(datos[1])$red, as.data.frame(datos[1])$nir,
    col="green")
 \end{lstlisting}
 \end{exa}

 \begin{exa}
     Extraer los promedios y desvios standar de un raster y agregarlos a un
     vector.
     \begin{lstlisting}
         promedio <- extract(l8,vector,fun=mean)
         desvio <- extract(l8,vector,fun=sd)
         colnames(promedio) <- paster("mean",colnames("promedio"),sep="_")
         colnames(desvio) <- paster("sd",colnames("desvio"),sep="_")
         vector@data <- cbind(vector@data,promedio,desvio)
         writeOGR(vector, sdn="vector_data/processed/,"datos",driver="ESRI
         Shapefile")
     \end{lstlisting}
 \end{exa}

 \begin{exa}
     Graficar las firmas espectrales en funcion de la longitud de onda para cada
     geometria de un vector.
     \begin{lstlisting}
         df <- t(promedio)
         colnames(df) <- vector@data$descripcion
         df$wl <- as.matrix(c(485,560,660,830,1650,2215))
         df <- melt(df,id.vars="wl", variable.name="cobertura")
         names(df) <- c("wl","Cobertura","Reflectancia")
         dfd <- t(desvio)
         colnames(dfd) <- vector@data$descripcion
         dfd$wl <- as.matrix(c(485,560,660,830,1650,2215))
         dfd <- melt("wl","Cobertura","Desvio")

         df$desvio <- dfd$desvio

         ggplot(df,aes(wl,Reflectancia)+
            geom_line(aes(colour=Cobertura))+
            geom_poinr(aes(colour=Cobertura))+
            geom_errorbar(aes(ymin=Reflectancia-2*desvio,
                              ymax=Reflectancia+2*desvio))
     \end{lstlisting}
 \end{exa}

 \begin{act}
    Grafique la media y el desvio standar para las distintas coberturas que pudo
     identificar en el punto uno. 
 \end{act}
\section{Rebotando por la atmosfera}
\label{sec:corr}
En esta segunda actividad practica nos centraremos en la correccion radiometrica
de imagenes satelitales. Son objetivos de la misma

\begin{itemize}
    \item Poder abrir una imagen satelital desde el metadato.
    \item Convertir los valores de la imagen a reflectancia tope de la
        atmosfera.
    \item Corregir la imagen satelital utilizando los metodos de \emph{dos} y
        \emph{cost}
    \item Corregir la imagen satelital utilizando el \emph{6S web}
\end{itemize}

\subsection{Correccion de imagenes en R}
\label{sub:corr:r}
Para abrir una imagen satelital desde el metadato utilizaremos las funciones
disponibles en \texttt{RStoolbox}. Dicho paquete incluye diversar herramientas
para trabajar con sensores remotos y ya lo utilizamos antes para graficar
imagenes satelitales.

\begin{exa}
   Comencemos analizando un ejemplo sencillo, abriremos una imagen landsat 5
    desde el metadato y la mostraremos en combinacion de bandas de falso color
    compuesto, ademas de analizar las propiedades basicas de la misma.
    \begin{lstlisting}
        library(raster)
        library(RStoolbox)
        meta.1992 <- readMeta("raster_data/LT52300771992104CUB00/LT52300771992104CUB00_MTL.txt")
        dn.1992 <- stackMeta(meta.1992)
        dn.1992 <- dn.1992[[-6,]]
        ggRGB(dn.1992, 
              r=4, g=3, b=2, 
              geom_raster = TRUE, 
              stretch = "lin")
    \end{lstlisting}
    
    Cargaremos de esta forma el metadato de la imagen landat 5 del año 1992,
    abriremos las bandas de la misma y la mostraremos en combinacion de falso
    color compuesto. Analicemos punto por punto que esta pasando.
    \begin{enumerate}
        \item Las lineas 1 y 2 del script leen las librerias que necesitamos
            para trabajar con la imagen.
        \item La linea 3 crea la variable \texttt{meta.1992} con los metadatos
            correspondientes a la imagen de interes.
        \item La linea 4 crea la variable \texttt{dn.1992} con las bandas
            estaqueadas para poder utilizarlas en R. Podemos inspeccionar el
            elemento poniendo su nombre en la consola.
        \item La linea 5 elimina la banda termica de nuestra imagen.
        \item Las lineas 6 a 9 nos permiten mostrar la imagen en combinacion
            falso color compuesto. De ella la linea 6 se refiere a la imagen a
            mostrar, la linea 7 a la combinacion de colores elegida y la 9 al
            tipo de realce aplicado.
    \end{enumerate}
\end{exa}

De esta forma podemos tener el archivo cargado en DN con todos sus metadatos
para convertirlo a reflectancia. Para pasar nuestra imagen a reflectancia a tope
de la atmosfera tenemos dos maneras de hacerlo. Podemos hacerlo a mano
utilizando las herramientas algebraicas de R o podemos hacerlo con la funcion
especifica de \texttt{RStoolbox}.

Veamos ambas. A mano

\begin{lstlisting}
    calref.1992 <- meta.1992$calref
    elev.1992 <- pi*meta.1992$SOLAR_PARAMETERS['elevation']/180
    dn2ref.1992 <- meta.1992$CALREF
    toa.1992 <- (dn.1992*dn2ref.1992$gain+dn2ref.1992$offset)/sin(elev.1992)
    names(toa.1992) <- c("B1_toa","B2_toa","B3_toa","B4_toa","B5_toa","B7_toa")
\end{lstlisting}

de forma automaica

\begin{lstlisting}
    toa.1992b <- radCor(dn.1992, metaData = meta.1992, method = "apref")
\end{lstlisting}

podemos comparar los resultados de ambos metodos inspeccionando los objetos.

\begin{act}
    Inspeccione la reflectancia a tope de la atmosfera para todas las bandas.
    Para esto realice los histogramas, graficos de dispersion, calcule la media,
    el desvio standar y cualquier otra medida estadistica que le guste.
\end{act}

La funcion \texttt{radCor} dispone distintos parametros para hacer distintos
tipos de correcciones atmosfericas. Ya vimos \emph{apref} que nos permitio
calcular la reflectancia a tope de la atmosfera. Veamos como aplicar el metodo
de substraccion de cuerpo obscuro.

\begin{lstlisting}
    haze.1992 <- estimateHaze(dn.1992,darkProp = 0.01, hazeBands = 1:4, plot=TRUE)
    sdos.1992 <- radCor(dn.1992, metaData = meta.1992, 
                 hazeValues = haze.1992,
                 hazeBands = c("B1_dn","B2_dn","B3_dn","B4_dn"), 
                 method="sdos")
\end{lstlisting}

\begin{act}
    Analice los valores de haze obtenidos por la funcion stimate hace y en caso
    de que sea necesario, corrijalos para la banda indicada.
\end{act}

\begin{act}
    Utilice el metodo \emph{costz} para corregir la imagen a reflectancia a tope
    de la superficie.
\end{act}

\begin{act}
    Guarde los archivos raser generado por cada uno de los metodos de
    correccion. Abralos en qgis y comparelos visualmente.    
\end{act}


\subsection{6S}
\label{sub:corr:6S}

Veamos ahora como operar con el 6S para obtener una estimacion de los parametros
atmosfericos. Para esto utilizaremos la version web del 6S que se encuentra
disponible en http://6s.ltdri.org/pages/run6SV.html.

Para utilizarla ingresaremos a la pagina y haremos click en el boton
\menu{Submit query}. Iremos luego configurando paso a paso nuestro modelo de la
atmosfera haciendo siempre luego click en el boton \menu{submit query} para
pasar al paso siguiente.

Los parametros para nuestro modelo son

\begin{enumerate}
    \item Geometrical conditions
        \begin{itemize}
            \item TM (Landsat)
            \item Month: 4, Day:13, GTM decimal hour: 13.60, Longitude:
                -63.8606, Latitude: -24.9937.
        \end{itemize}
    \item Atmospheric Model
        \begin{itemize}
            \item Select Atmospheric Profile: Mid latitude summer
            \item Select aerosol model: Continental Model
            \item Visibility: 60
        \end{itemize}
    \item Target \& sensor altitude
        \begin{itemize}
            \item Select targe altitude: sea level
            \item Select sensor altitude: satellite level
        \end{itemize}
    \item Spectral conditions
        \begin{itemize}
            \item Select spectral conditions: choose band
            \item Select band: 1st band of tm (landat 5)
        \end{itemize}
    \item Ground reflectance
        \begin{itemize}
            \item Ground reflectance type: homogeneous surface
            \item Directional effect: no directional effect
            \item Specify surface reflectance: input constant value of ro
            \item input constant value for ro: 0
        \end{itemize}
    \item Signal
        \begin{itemize}
            \item Atmospheric correction mode: no atmospheric correction
        \end{itemize}
\end{enumerate}

En \menu{7.Results} podemos ver el resultado haciendo click en \emph{Output
file}

Una vez ejecutado el proceso puede usarse el siguiente codigo para corregir
todas las bandas utilizando R.

\begin{lstlisting}
    a <- c(0.98,0.90,...)
    b <- c(0.81,0.90,...)
    g <- c(0.15,0.10,...)
    r <- c(0.08,0.05,...)
    sss.1992 <- (toa.1992/(a*b)-r/b)/(1+g*(toa.1992/(a*b)-r/b))
\end{lstlisting}


\begin{act}
    Realice una extraccion de firmas espectrales para distintass coberturass de
    cada uno de los archivos raster obtenidos y grafiquelos en el mismo grafico.
    Comparela con la firma espectral obtenida a partir de la imagen corregida
    por el usgs.
\end{act}

\section{Un abaco espectral}
\label{sec:abaco}

Veamos ahora como realizar operaciones sencillas entre las bandas de una imagen.
Usaremos en esta practica los siguientes paquetes

\begin{lstlisting}
    library(raster)
    library(RStoolbox)
    library(RColorBrewer)
    library(rgdal)
    library(ggplot2)
    libyrary(GGally)
\end{lstlisting}

Comenzamos primer cargando la imagen desde el metadato y convirtiendola a
reflectancia como hicimos en la clase anterior

\begin{lstlisting}
    xml.2016 <- readMeta("raster_data/LC.../LC....xml")
    ref.2016 <- stackMeta(xml.2016, quantity = "sre")
    scaleF <- getMeta(ref.2015,xml.2016, what = "SCALE_FACTOR")
    ref.2016 <- ref.2016 * scaleF
    ref.2016 <- ref.2016[[-1,]]
    names(ref.2016) <- c("blue","green","red","nir","swir1","swir2")
\end{lstlisting}

una vez cargada la imagen podemos realizar operaciones entre las bandas llamando
a cada una por separado. Veamos como ejemplo el calculo de NDVI\@.

\begin{exa}
    Calculo de NDVI a mano y grafico del mismo
    \begin{lstlisting}
        ndvi.2016 <- (ref.2016$nir-ref.2016$red)/(nir.2016$nir+ref.2016$ref)
        cols = colorRampPalette(brewer.pal(9,"YlGn"))(16)
        plot(ndvi.2016, col=cols, zlim = c(0,1))
    \end{lstlisting}
    obteniendo una imagen como la que se ve debajo.
\end{exa}

El paquete \texttt{RStoolbox} tiene varias herramientas que nos ayudan a
calcular los indices espectrales. Veamos por ejemplo como calcular el NDVI y el
EVI utilizando dicho paquete

\begin{exa}
    Para calcular los indices mediante la funcion spectralIndices debemos
    especificar con que raster trabajamos y que bandas corresponden a cada
    longitud de onda
    \begin{lstlisting}
    indices.2016 <- spectralIndices(ref.2016, 
                                    blues="blue", red="red", nir="nir", 
                                    indices=c("NDVI","EVI"))
    plot(indices.2016,col=cols, zlim=c(0,1))
    \end{lstlisting}
    obtenemos una imagen como se muestra debajo.
\end{exa}

\begin{act}
    Calcule el NDVI para el año 2000 utilizando la imagen landsat 7.
\end{act}

\begin{act}
    Calcule y grafique todos los indices posibles que involucren a las bandas
    roja y nir de landsat 8. 
\end{act}


\begin{exa}
    Veamos ahora como calcular el tSAVI utilizando la linea de suelo obtenida a
    partir de la imagen. Para esto necesitaremos enmascarar las zonas con
    cobertura de agua y nubes. Veamos primer como hacer esto.
    \begin{lstlisting}
        mask.2016 <- raster("raster/.../...cfmask.tif")
        masked.2016 <- mask(ref.2016, mask=mask.2016, inverse=TRUE,
                            maskvalue=0, updatevalue=255)
        masked.2016[masked.2016<=0] <- 255
    \end{lstlisting}
    de esta forma enmascaramos todos los valores con nubes, agua y donde la
    reflectancia obtenida es cero.
    Calculamos ahora la linea de suelo y la mostramos en un scatterplot
    \begin{lstlisting}
        bsl.2016 <- BSL(as.matrix(masked.2016$red), as.matrix(masked.2016$nir),
                        method="quantile", ulimimt=0.99, llimit=0.001)
        plot(ref.2016$red, ref.2016$nir)
        abline(bsl.2016$BSL,col="red")
    \end{lstlisting}
\end{exa}

\begin{act}
    Calcule el tSAVI utilizando la linea de suelo obtenida arriba.
\end{act}

\begin{act}
    Vuelva a obtener la linea de suelo sin enmascarar la imagen y dibujo el
    scatterplot con la misma y la anterior. Que problema encuentra.
\end{act}

Finalmente, veamos como se puede obtener datos biofisicos a partir de los
indices de vegetacion calculados. De esta forma podremos generar mapas de
porcentaje de cobertura, productividad, etc.

\begin{act}
    Cargue la capa vectorial del muestreo de variables biofisicas
    \texttt{muestreo.shp} y haga una extraccion de los valores de NDVI
    correspondientes a dichos puntos. Guarde estos valores en un dataframe
    llamado \texttt{muestreo}.
\end{act}

\begin{exa}
    Veamos como ajustar con R un modelo lineal a nuestro modelo. Para esto
    comencemos haciendo un analisis visual con la funcion \texttt{ggpairs}.
    \begin{lstlisting}
        ggpairs(muestreo,diag=list(continuous="barDiag"))
    \end{lstlisting}
    Obtendremos un grafico que presenta los scatterplots entre las bandas, su
    correlacion e histogramas.
    Veamos en el mismo que la superficie cubierta por vegetacion varia
    linealmente con el NDVI\@. Por lo tanto utilizaremos estos para hacer un
    ajuste de nuestro modelo.
    \begin{lstlisting}
        lm.2016 <- lm(fcover~ndvi, data=muestreo)
        plot(muestreo$ndvi, mustreo$fcover)
        abline(lm.2016, col="red")
        summary(lm.2016)
    \end{lstlisting}
    de esta forma veremos los parametros de nuestro ajuste, y graficaremos al
    mismo en un scatterplot.

    Para aplicar el modelo a nuestro raster hacemos
    \begin{lstlisting}
        fcover.2016 <- predict(ndvi.2016,lm.2016)
        plot(fcover.2016)
    \end{lstlisting}
    Obteniendo el mapa de abajo.
\end{exa}

\begin{act}
    Genere los modelos de lai, fapar y fcover para el año 2016 y con los mismos
    realice mapas de dichas variables.
\end{act}

\begin{act}
    Utilizando los modelos obtenidos para 2016 aplique los mismos para obtener
    los mapas de lai, fapar y fcover del año 2000. Que suposicion esta
    haciendo?
\end{act}

\begin{act}
    * Utilizando la funcion spectralIndices y ggpairs, analice si hay otro indice
    que ajuste que correlacione mejor con las alguna de las varibles biofisicas
    medidas a campo.
\end{act}

\section{Rotaciones espectrales}
\label{sec:rota}
Durante la clase de hoy trabajaremos con rotaciones en el espacio espectral. A
diferencia del trabajo con indices las rotaciones pueden interpretarse no como
algebra entre las bandas sino como distintas formas de mirar al mismo espacio
espectral.

En este caso usaremos las librerias \texttt{raster} y \texttt{RStoolbox}.

\begin{lstlisting}
    library(raster)
    library(RStoolbox)
    library(bfastSpatial)
\end{lstlisting}


\begin{exa}
    Comencemos analizando la transformada por componentes principales de la
    imagen de 2016. Que podemos predecir?
    \begin{lstlisting}
        pairs(ref.2016)
    \end{lstlisting}

    Mirando el resumen de la imagen vemos que hay varias bandas muy
    correlacionadas entre si. Por ejemplo las del visible, mientras que otras lo
    estan poco, por el ejeplo el nir y el swir. Por lo tanto esperamos que no
    todas las bandas sean necesarias para explicar el comportamiento de la
    imagen


    \begin{lstlisting}
        pca.2016 <- rasterPCA(ref.2016)
        summary(pca.2016$model)
        loadings(pcs.2016$model)
        plot(pca.2016$map)
    \end{lstlisting}

\end{exa}

\begin{act}
    Calcule y analice la transformada por PCA de la imagen Landsat 7 del año
    2000.
\end{act}

\begin{exa}
    Otra aplicacion de la transformada por componentes principales por
    componentes principales. Veamos como realizarlo.
    \begin{lstlisting}
        ndvi.list <- list.files("raster_data/MOD13Q1/EVI/", pattern = "*.tif$",
                                 full.names = TRUE)
        ndvi.stack <- stack(ndvi.list)
    \end{lstlisting}
    una vez abierta la imagen la convertimos a valores entre -1 y 1 e
    interpolamos los valores que falten.
    \begin{lstlisting}
        ndvi.stack <- ndvi.stak/1e4
        ndvi.stack <- approxNA(ndvi.stack)
    \end{lstlisting}
    Una vez llenados los espacios donde no habia datos podemos aplicar la
    transformada por componentes principales y mostrarla
    \begin{lstlisting}
        ndvi.pca <- rasterPCA(ndvi.stack)
    \end{lstlisting}
\end{exa}

\begin{act}
    Grafique las primeras 4 componentes por de la transformada por componentes
    princiales de la imagen del stack de NDVI\@. Que zonas puede identificar en la
    primera? que zonas se distinguen en la segunda? que comportamiento encuentra
    en la tercera y cuarta.
\end{act}

\begin{act}
    Investigue la funcion \texttt{tasseledCap} y calcule la transformada
    tasseled cap para las imagenes landsat 7 y 8.
\end{act}

\begin{act}
    Grafique en el scatter-plot la imagen completa y marque en el mismo zonas
    con vegetacion, agua y suelo sin cobertura vegetal. Vea como cambian estas
    zonas frente a las transformadas por componentes principales y tasseled cap.
\end{act}

\section{Clasificacion no supervisada de imagenes}
\label{sec:nosup}
En esta clase vamos a trabajar con clasificaciones no supervisadas de imagenes
satelitales. Vamos a usar los paquetes

\begin{lstlisting}
    library(raster)
    library(RStoolbox)
\end{lstlisting}

Cargaremos primero la imagen landsat 8 y habilitaremos la opcion para escribir
el header de ENVI.

\begin{lstlisting}
    rasterOptions(addheader = "ENVI")
    set.seed(6)
    kmeans.2016 <- unsuperClass(ref.2016, nClasses = 5, nStarts = 100,
                                nSamples = 100)
    writeRaster(kmeans.2016, "raster_data/processed/kmeans2016",
                datatype="INT1U")
\end{lstlisting}

Podemos ahora graficar por separado cada una de las clases

\begin{lstlisting}
    classes.2016 <- layerize(kmeans.2016)
    plot(classes.2016)
\end{lstlisting}

Abriremos la imagen ahora en el qgis e identificaremos cada una de las clases
realiando interpretacion visual de la imagen. 

Para realizar la identificacion primero vamos al menu \menu{propiedades de la
imagen, Estilo, Tipo de renderizacion, Unibanda pseudocolor}. Elegimos de modo
Intervalo Igual y en numero de clases ponemos con el minimo en 1 y el maximo en
100. En estilo de color elegimos colores aleatorios. Iremos luego cambiando los
colores uno a uno por un color brillante e identificado a que cobertura
pertenece dicha clase espectral.

Construiremos con ella una tabla como la siguiente

\begin{verbatin}
    id  class
    1   1
    2   1
    3   2
    4   5
    5   7
\end{verbatin}

que guardaremos en un archivo de texto. El mismo lo utilizaremos para realizar
la fusion de clases.

Una vez conocidas las categorias de uso y cobertura correspondientes a cada
clase espectral podemos combinarlas

\begin{lstlisting}
    clases.2016 <- read.delim("class")
    reclas.2016 <- subs(kmeans.2016$map, clases.2016)
\end{lstlisting}

\end{document}
