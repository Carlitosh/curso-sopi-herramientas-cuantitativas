\documentclass[a4paper]{article}

% Preambulo por defecto
\input{preamble.tex}

\input{commands.tex}

\begin{document}

\section*{Introducción}
\label{sec:intro}
 
\section{Un viaje del sol a los pixeles.}
\label{sec:fep}
 En esta primera práctica nos familiarizaremos con las interfaces gráficas del
 qgis y de R-studio. Para esto comenzaremos a analizar la imagen correspondiente
 a la zona de estudio del año 2015 desde el punto de vista espectral. Son
 nuestros objetivos

 \begin{itemize}
     \item Poder cargar una imagen en qgis.
     \item Digitalizar coberturas en qgis.
     \item Poder cargar un archivo raster y uno vectorial en R.
     \item Realizar un análisis estadistico de la imagen como un todo y de las
         distintan coberturas digitalizar en R.
 \end{itemize}
\subsection{Exploración con el qgis}
\label{sub:fep:qgis}

 Comenzamos abriendo la imagen \file{l8} correspondiente a la zona de interés
 durante el mes de mayo de 2015. Para esto vamos al menú \menu{Capa, Añadir
 capa, Añadir capa ráster}. Navegamos hasta la carpeta
 \file{raster\_data/LC82300772015071} y abrimos el archivo
 \file{LC82300772015071.brk}. Una vez abierto el mismo podrémos encontarrlo en
 el \menu{Panel de capas} de q-gis donde podremos manejar la visualización del
 mismo y estudiar las propiedades de dicha capa.

 Usando la barra de herramientas del qgis podremos movernos en la imagen,
 realizar zoom en la misma entontre otros.

 \begin{act} 
     Cambie la combinación de bandas de la imagen L8 y muevase  dentro de la
     misma.
 \end{act}

 \begin{act}
     Encuentre el sistema de coordenadas en el cual se encuentra la imagen.
 \end{act}
 
 \begin{act}
    Utilizando la herramienta identificar objetos espaciles encuentre los
    valores de reflectancia de distintas coberturas. Grafique estos  valores en
    una firma espectral y en el espacio de fases nirrojo.
 \end{act}

 Con la herramienta nueva capa de archivo shape es posible digitalizar zonas de
 la imagen para su posterior analisis. Para esto puede hacer click en el boton
 del panel lateral y agregar una capa nueva para lo cual el qgis pedira un
 nombre de la misma. Guardela en la carpeta \file{vector\_data/} con el nombre
 \file{firmas.shp}. Recuerde elegir el sistema de coordenadas correspondiente a
 la imagen anterior.

 Una vez creada la nueva capa podemos utilizar la barra de herramientas de qgis
 para agregar nuevas geometrias a la misma. Para esto hacemos click en el boton
 de agregar geometrica y digitalizamos una zona uniforme dentro de la imagen. Al
 terminar de acerlo qgis pedira un numero de ID para la capa que debe ser
 correlativo.
 
 \begin{act}
    Digitalize coberturas uniformes dentro de la imagen. Recuerde obtener al
    menos una por cada categoria de uso y cobertura presente dentro de la misma.
 \end{act}

 \begin{act}
    Utilizando la herramienta de tabla de datos de la imagen modifique la tabla
    de datos para incluir la categoria de la cobertura, la subcategoria y una 
    pequeña descripcion.
 \end{act}


\subsection{Exploracion en R}
\label{sub:fep:r}
 Para trabajar en R deberemos primero cargar las librerias necesarias con el
 comando

 \begin{lstlisting}
    library(raster)
 \end{lstlisting}

 además, deberemos situar nuestra carpeta de trabajo donde se encuentran las
 carpetas que descargamos. Para esto nos movemos en el explorar de archivos
 hasta la misma y hacemos click en usar la carpeta como carpeta de trabajo.

 Una vez en dicha carpeta, existen varias maneras de abrir una imagen segun
 queramos hacerlo solo para una banda, varias bandas en archivos separados o un
 solo archivo multibanda.

 Los comandos para esto son \texttt{raster}, para abrir una unica banda,
 \texttt{brick}, para abrir un archivo multibanda, y \texttt{stack} para abrir
 distinas bandas por separado. Veamos algunos ejemplo de esto:

 \begin{exa}
    Abrimos la imagen completa del archivo de landsat 8 y consultamos sus 
    propiedades.
 \begin{lstlisting}
    l8 <- brick(filename)
    l8
 \end{lstlisting}
 \end{exa}


 Una vez abierta la imagen en el R podemos empezar a trabajar con la misma
 utilizando distintos comandos. 

 Veamos primero como cambiar los nombres de las bandas por defecto, cambiar la
 imagen a numeros en reflectancia entre 0 y 1 y luego guardarla nuevamente. Para
 eso ejecutamos el siguiente codigo.

 \begin{lstlisting}
     l8 <- brick(filename)
     names(l8) <- c("blue","gree","red","nir","swir1","swir2")
     l8 <- l8/1e4
     rasterOptions(addheader = "ENVI")
     writeRaster(l8\_ref,"raster\_data/processed/")
 \end{lstlisting}

 Analicemos el codigo linea por linea. La primera de ellas abre la imagen como
 un raster de multiples bandas. La segunda, cambia los nombres de cada banda a
 los que figuran en la lista entre parentesis. Es importante resaltar que el
 numero de nombres debe ser el mismo que el de bandas. En tercer lugar
 convertimos el archivo de numeros enteros entre 0 y 10000 a numeros entre 0 y
 1. En la cuarta linea incluimos el archivo header que nos permitira levantar
 nuestra imagen con qgis. Por ulitmo, guardamos el archivo en el formato nativo
 de R.
 
 \begin{act} 
    Abra el archivo vrt en qgis y vuelva a mirar la firma espectral para 
    distintas coberturas. Entre que valores se encuentra ahora las mismas.
 \end{act}

 Hagamos un poco de analisis ahora sobre la imagen. Para comenzar podemos
 calcular los histogramas de todas las bandas con el comando

 \begin{lstlisting}
    hist(l8) 
 \end{lstlisting}

 y el scatter plot entre dos bandas como

 \begin{lstlisting}
    plot(l8$red, l8$blue)    
 \end{lstlisting}

 en caso de querer todos los scatterplots e histogramas en un solo grafico
 podemos hacerlo con el comando

 \begin{lstlisting}
     pairs(l8)
 \end{lstlisting}

 Hasta ahora estamos analizando la imagen completa. Podemos sin embargo analizar
 solo sectores concretos de la imagen muestreandola en funcion de un shapefile.
 Para esto debemos primero abrir el shapefile de interes cargando primero la
 libreria

 \begin{lstlisting}
     library(rgal)
 \end{lstlisting}

 y luego leyendo el vector como

 \begin{lstlisting}
     vector <- readOGR(dsn="vector\_data/", layer="extract")
 \end{lstlisting}

 Podemos mostrar las propiedades del vector ejecutando el comando

 \begin{lstlisting}
     vector
 \end{lstlisting}

 \begin{act} 
    Muestre las propiedades de la capa raster y el vector abiertos y verifique
    que los mismos se encuentren en el mismo sistema de coordenadas.
 \end{act}

 Podemos mostrar las imagenes dentro de R si así nos interesa. Para esto
 utilizaremos la libreria \texttt{ggplot} como se muestra a continuacion

 \begin{lstlisting}
    ggRGB(l8, r="nir",g="red",b="blue", geom_raster=TRUE) 
 \end{lstlisting}

 Por ultimo mostremos como extraer datos de un archivo raster y veamos un par de
 ejemplo concretos. La funcion que nos permite extrar datos de un raster segun
 un vector es \texttt{extract} que toma dos argumentos
 \begin{lstlisting}
     raster(l8,vector)
 \end{lstlisting}

 Veamos algunos ejemplos que pueden ser utiles de aplicacion de todo lo anterior

 \begin{exa}
    Graficar en un scatterplot de dos bandas mostrando la zona del espacio 
    ocupada por una cobertura.
 \begin{lstlisting}
    plot(l8$red, l8$nir)
    points(as.data.frame(datos[1])$red, as.data.frame(datos[1])$nir,
    col="green")
 \end{lstlisting}
 \end{exa}

 \begin{exa}
     Extraer los promedios y desvios standar de un raster y agregarlos a un
     vector.
     \begin{lstlisting}
         promedio <- extract(l8,vector,fun=mean)
         desvio <- extract(l8,vector,fun=sd)
         colnames(promedio) <- paster("mean",colnames("promedio"),sep="_")
         colnames(desvio) <- paster("sd",colnames("desvio"),sep="_")
         vector@data <- cbind(vector@data,promedio,desvio)
         writeOGR(vector, sdn="vector_data/processed/,"datos",driver="ESRI
         Shapefile")
     \end{lstlisting}
 \end{exa}

 \begin{exa}
     Graficar las firmas espectrales en funcion de la longitud de onda para cada
     geometria de un vector.
     \begin{lstlisting}
         df <- t(promedio)
         colnames(df) <- vector@data$descripcion
         df$wl <- as.matrix(c(485,560,660,830,1650,2215))
         df <- melt(df,id.vars="wl", variable.name="cobertura")
         names(df) <- c("wl","Cobertura","Reflectancia")
         dfd <- t(desvio)
         colnames(dfd) <- vector@data$descripcion
         dfd$wl <- as.matrix(c(485,560,660,830,1650,2215))
         dfd <- melt("wl","Cobertura","Desvio")

         df$desvio <- dfd$desvio

         ggplot(df,aes(wl,Reflectancia)+
            geom_line(aes(colour=Cobertura))+
            geom_poinr(aes(colour=Cobertura))+
            geom_errorbar(aes(ymin=Reflectancia-2*desvio,
                              ymax=Reflectancia+2*desvio))
     \end{lstlisting}
 \end{exa}

 \begin{act}
    Grafique la media y el desvio standar para las distintas coberturas que pudo
     identificar en el punto uno. 
 \end{act}
\section{Rebotando por la atmosfera}
\label{sec:corr}
En esta segunda actividad practica nos centraremos en la correccion radiometrica
de imagenes satelitales. Son objetivos de la misma

\begin{itemize}
    \item Poder abrir una imagen satelital desde el metadato.
    \item Convertir los valores de la imagen a reflectancia tope de la
        atmosfera.
    \item Corregir la imagen satelital utilizando los metodos de \emph{dos} y
        \emph{cost}
    \item Corregir la imagen satelital utilizando el \emph{6S web}
\end{itemize}

\subsection{Correccion de imagenes en R}
\label{sub:corr:r}
Para abrir una imagen satelital desde el metadato utilizaremos las funciones
disponibles en \texttt{RStoolbox}. Dicho paquete incluye diversar herramientas
para trabajar con sensores remotos y ya lo utilizamos antes para graficar
imagenes satelitales.

\begin{exa}
   Comencemos analizando un ejemplo sencillo, abriremos una imagen landsat 5
    desde el metadato y la mostraremos en combinacion de bandas de falso color
    compuesto, ademas de analizar las propiedades basicas de la misma.
    \begin{lstlisting}
        library(raster)
        library(RStoolbox)
        meta.1992 <- readMeta("raster_data/LT52300771992104CUB00/LT52300771992104CUB00_MTL.txt")
        dn.1992 <- stackMeta(meta.1992)
        dn.1992 <- dn.1992[[-6,]]
        ggRGB(dn.1992, 
              r=4, g=3, b=2, 
              geom_raster = TRUE, 
              stretch = "lin")
    \end{lstlisting}
    
    Cargaremos de esta forma el metadato de la imagen landat 5 del año 1992,
    abriremos las bandas de la misma y la mostraremos en combinacion de falso
    color compuesto. Analicemos punto por punto que esta pasando.
    \begin{enumerate}
        \item Las lineas 1 y 2 del script leen las librerias que necesitamos
            para trabajar con la imagen.
        \item La linea 3 crea la variable \texttt{meta.1992} con los metadatos
            correspondientes a la imagen de interes.
        \item La linea 4 crea la variable \texttt{dn.1992} con las bandas
            estaqueadas para poder utilizarlas en R. Podemos inspeccionar el
            elemento poniendo su nombre en la consola.
        \item La linea 5 elimina la banda termica de nuestra imagen.
        \item Las lineas 6 a 9 nos permiten mostrar la imagen en combinacion
            falso color compuesto. De ella la linea 6 se refiere a la imagen a
            mostrar, la linea 7 a la combinacion de colores elegida y la 9 al
            tipo de realce aplicado.
    \end{enumerate}
\end{exa}

De esta forma podemos tener el archivo cargado en DN con todos sus metadatos
para convertirlo a reflectancia. Para pasar nuestra imagen a reflectancia a tope
de la atmosfera tenemos dos maneras de hacerlo. Podemos hacerlo a mano
utilizando las herramientas algebraicas de R o podemos hacerlo con la funcion
especifica de \texttt{RStoolbox}.

Veamos ambas. A mano

\begin{lstlisting}
    calref.1992 <- meta.1992$calref
    elev.1992 <- pi*meta.1992$SOLAR_PARAMETERS['elevation']/180
    dn2ref.1992 <- meta.1992$CALREF
    toa.1992 <- (dn.1992*dn2ref.1992$gain+dn2ref.1992$offset)/sin(elev.1992)
    names(toa.1992) <- c("B1_toa","B2_toa","B3_toa","B4_toa","B5_toa","B7_toa")
\end{lstlisting}

de forma automaica

\begin{lstlisting}
    toa.1992b <- radCor(dn.1992, metaData = meta.1992, method = "apref")
\end{lstlisting}

podemos comparar los resultados de ambos metodos inspeccionando los objetos.

\begin{act}
    Inspeccione la reflectancia a tope de la atmosfera para todas las bandas.
    Para esto realice los histogramas, graficos de dispersion, calcule la media,
    el desvio standar y cualquier otra medida estadistica que le guste.
\end{act}

La funcion \texttt{radCor} dispone distintos parametros para hacer distintos
tipos de correcciones atmosfericas. Ya vimos \emph{apref} que nos permitio
calcular la reflectancia a tope de la atmosfera. Veamos como aplicar el metodo
de substraccion de cuerpo obscuro.

\begin{lstlisting}
    haze.1992 <- estimateHaze(dn.1992,darkProp = 0.01, hazeBands = 1:4, plot=TRUE)
    sdos.1992 <- radCor(dn.1992, metaData = meta.1992, 
                 hazeValues = haze.1992,
                 hazeBands = c("B1_dn","B2_dn","B3_dn","B4_dn"), 
                 method="sdos")
\end{lstlisting}

\begin{act}
    Analice los valores de haze obtenidos por la funcion stimate hace y en caso
    de que sea necesario, corrijalos para la banda indicada.
\end{act}

\begin{act}
    Utilice el metodo \emph{costz} para corregir la imagen a reflectancia a tope
    de la superficie.
\end{act}

\begin{act}
    Guarde los archivos raser generado por cada uno de los metodos de
    correccion. Abralos en qgis y comparelos visualmente.    
\end{act}


\subsection{6S}
\label{sub:corr:6S}

Veamos ahora como operar con el 6S para obtener una estimacion de los parametros
atmosfericos. Para esto utilizaremos la version web del 6S que se encuentra
disponible en http://6s.ltdri.org/pages/run6SV.html.

Para utilizarla ingresaremos a la pagina y haremos click en el boton
\menu{Submit query}. Iremos luego configurando paso a paso nuestro modelo de la
atmosfera haciendo siempre luego click en el boton \menu{submit query} para
pasar al paso siguiente.

Los parametros para nuestro modelo son

\begin{enumerate}
    \item Geometrical conditions
        \begin{itemize}
            \item TM (Landsat)
            \item Month: 4, Day:13, GTM decimal hour: 13.60, Longitude:
                -63.8606, Latitude: -24.9937.
        \end{itemize}
    \item Atmospheric Model
        \begin{itemize}
            \item Select Atmospheric Profile: Mid latitude summer
            \item Select aerosol model: Continental Model
            \item Visibility: 60
        \end{itemize}
    \item Target \& sensor altitude
        \begin{itemize}
            \item Select targe altitude: sea level
            \item Select sensor altitude: satellite level
        \end{itemize}
    \item Spectral conditions
        \begin{itemize}
            \item Select spectral conditions: choose band
            \item Select band: 1st band of tm (landat 5)
        \end{itemize}
    \item Ground reflectance
        \begin{itemize}
            \item Ground reflectance type: homogeneous surface
            \item Directional effect: no directional effect
            \item Specify surface reflectance: input constant value of ro
            \item input constant value for ro: 0
        \end{itemize}
    \item Signal
        \begin{itemize}
            \item Atmospheric correction mode: no atmospheric correction
        \end{itemize}
\end{enumerate}

En \menu{7.Results} podemos ver el resultado haciendo click en \emph{Output
file}

Una vez ejecutado el proceso puede usarse el siguiente codigo para corregir
todas las bandas utilizando R.

\begin{lstlisting}
    a <- c(0.98,0.90,...)
    b <- c(0.81,0.90,...)
    g <- c(0.15,0.10,...)
    r <- c(0.08,0.05,...)
    sss.1992 <- (toa.1992/(a*b)-r/b)/(1+g*(toa.1992/(a*b)-r/b))
\end{lstlisting}



\begin{act}
    Realice una extraccion de firmas espectrales para distintass coberturass de
    cada uno de los archivos raster obtenidos y grafiquelos en el mismo grafico.
    Comparela con la firma espectral obtenida a partir de la imagen corregida
    por el usgs.
\end{act}

\end{document}
